<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Replier - Khair</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/sidebar.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-content">
                <div class="nav-left">
                    <div class="nav-brand">
                        <span class="logo">Khair</span>
                        <span class="tagline">Email Replier Agent</span>
                    </div>
                </div>
                <div class="nav-right">
                    {% if has_gmail %}
                    <div class="nav-search">
                        <div class="search-container">
                            <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="m21 21-4.35-4.35"/>
                            </svg>
                            <input type="text" id="emailSearch" class="search-input" placeholder="Search emails..." onkeyup="handleSearch(event)" oninput="handleSearchInput(this.value)">
                            <button class="search-clear" id="searchClear" onclick="clearSearch()" style="display: none;">√ó</button>
                        </div>
                    </div>
                    {% endif %}
                    <div class="nav-actions">
                        {% if has_gmail %}
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button class="nav-icon-btn" id="refreshEmailsBtn" onclick="refreshEmails()" title="Refresh emails">
                                <svg class="nav-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                                </svg>
                            </button>
                            <span id="emailCount" style="font-size: 14px; color: var(--text-secondary); font-weight: 500;"></span>
                        </div>
                        {% endif %}
                        <button class="nav-icon-btn" onclick="openSettingsModal()" title="Settings">
                            <svg class="nav-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </button>
                        <div class="nav-user-menu">
                            {% if current_user.profile_picture %}
                            <img src="{{ current_user.profile_picture }}" alt="{{ current_user.full_name or current_user.username }}" class="nav-user-avatar" onclick="toggleUserDropdown()">
                            {% else %}
                            <div class="nav-user-avatar-placeholder" onclick="toggleUserDropdown()">
                                {{ (current_user.full_name or current_user.username)[0].upper() }}
                            </div>
                            {% endif %}
                            
                            <!-- User Dropdown Menu -->
                            <div id="userDropdownMenu" class="user-dropdown-menu" style="display: none;">
                                <div class="user-dropdown-header">
                                    <div class="user-dropdown-info">
                                        <div class="user-dropdown-name">{{ current_user.full_name or current_user.username }}</div>
                                        <div class="user-dropdown-email">{{ current_user.email }}</div>
                                    </div>
                                </div>
                                <div class="user-dropdown-divider"></div>
                                <a href="/logout" class="user-dropdown-item">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                                        <polyline points="16 17 21 12 16 7"/>
                                        <line x1="21" y1="12" x2="9" y2="12"/>
                                    </svg>
                                    <span>Logout from Khair</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="dashboard-layout">
        {% if has_gmail %}
        <!-- Hamburger Menu Button (positioned above sidebar) -->
        <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
            <span class="hamburger-icon">‚ò∞</span>
        </button>
        
        <!-- Left Sidebar (Gmail-style) -->
        <aside class="sidebar" id="sidebar">
            <nav class="sidebar-nav">
                <button class="sidebar-item compose-btn" onclick="openComposeModal()" title="Compose new email">
                    <span class="sidebar-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                    </span>
                    <span class="sidebar-label">Compose</span>
                </button>
                <button class="sidebar-item active" onclick="switchTab('all')" data-tab="all" data-label="Inbox">
                    <span class="sidebar-icon icon-inbox">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                        </svg>
                    </span>
                    <span class="sidebar-label">Inbox</span>
                    <span class="sidebar-unread-count" id="unread-count-all" style="display: none;"></span>
                </button>
                <button class="sidebar-item" onclick="switchTab('sent')" data-tab="sent" data-label="Sent">
                    <span class="sidebar-icon icon-sent">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </span>
                    <span class="sidebar-label">Sent</span>
                </button>
                <button class="sidebar-item" onclick="switchTab('starred')" data-tab="starred" data-label="Starred">
                    <span class="sidebar-icon icon-starred">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                        </svg>
                    </span>
                    <span class="sidebar-label">Starred</span>
                </button>
                <button class="sidebar-item" onclick="switchTab('drafts')" data-tab="drafts" data-label="Drafts">
                    <span class="sidebar-icon icon-drafts">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                    </span>
                    <span class="sidebar-label">Drafts</span>
                </button>
            </nav>
            
            <div class="sidebar-divider"></div>
            
            <div class="sidebar-section" id="categoriesSection">
                <div class="sidebar-section-title">CATEGORIES</div>
                <button class="sidebar-item" onclick="switchTab('deal-flow')" data-tab="deal-flow" data-label="Deal Flow">
                    <span class="sidebar-icon icon-deal-flow">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                        </svg>
                    </span>
                    <span class="sidebar-label">Deal Flow</span>
                    <span class="sidebar-unread-count" id="unread-count-deal-flow" style="display: none;"></span>
                </button>
                <button class="sidebar-item" onclick="switchTab('networking')" data-tab="networking" data-label="Networking">
                    <span class="sidebar-icon icon-networking">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20.42 4.58a5.4 5.4 0 0 0-7.65 0l-.77.78-.77-.78a5.4 5.4 0 0 0-7.65 0C1.46 6.7 1.33 10.28 4 13l8 8 8-8c2.67-2.72 2.54-6.3.42-8.42z"></path>
                        </svg>
                    </span>
                    <span class="sidebar-label">Networking</span>
                    <span class="sidebar-unread-count" id="unread-count-networking" style="display: none;"></span>
                </button>
                <button class="sidebar-item" onclick="switchTab('hiring')" data-tab="hiring" data-label="Hiring">
                    <span class="sidebar-icon icon-hiring">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </span>
                    <span class="sidebar-label">Hiring</span>
                    <span class="sidebar-unread-count" id="unread-count-hiring" style="display: none;"></span>
                </button>
                <button class="sidebar-item" onclick="switchTab('general')" data-tab="general" data-label="General">
                    <span class="sidebar-icon icon-general">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                            <polyline points="22,6 12,13 2,6"></polyline>
                        </svg>
                    </span>
                    <span class="sidebar-label">General</span>
                    <span class="sidebar-unread-count" id="unread-count-general" style="display: none;"></span>
                </button>
                <button class="sidebar-item" onclick="switchTab('spam')" data-tab="spam" data-label="Spam">
                    <span class="sidebar-icon icon-spam">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </span>
                    <span class="sidebar-label">Spam</span>
                    <span class="sidebar-unread-count" id="unread-count-spam" style="display: none;"></span>
                </button>
            </div>
        </aside>
        {% endif %}

        <!-- Main Content Area -->
        <main class="main-content">
            {% if needs_setup %}
            <!-- First-Time Setup Screen -->
            <div class="setup-screen" id="setupScreen">
                <div class="setup-content">
                    <div class="setup-loading"></div>
                    <div class="setup-icon" id="setupIcon" style="display: none;">üöÄ</div>
                    <h2>Setting up your inbox...</h2>
                    <div class="setup-timer-container">
                        <div class="timer-display" id="timerDisplay">
                            <span class="timer-minutes" id="timerMinutes">5</span>
                            <span class="timer-separator">:</span>
                            <span class="timer-seconds" id="timerSeconds">00</span>
                        </div>
                        <p class="motivational-quote" id="motivationalQuote">Good things take time...</p>
                    </div>
                    <div class="setup-progress" id="setupProgress">
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="setupProgressBar"></div>
                        </div>
                        <p class="progress-text" id="setupProgressText">Initializing...</p>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if not has_gmail and not needs_setup %}
            <!-- Gmail Connection Required -->
            <div class="gmail-connection-prompt">
                <div class="gmail-connection-content">
                    <div class="gmail-connection-icon">üìß</div>
                    <h2>Connect Your Gmail Account</h2>
                    <p>To use Khair Email Replier Agent, you need to connect your Gmail account first.</p>
                    <p class="gmail-connection-subtitle">This allows the system to read and manage your emails securely.</p>
                    <a href="{{ url_for('connect_gmail') }}" class="btn btn-primary btn-large">
                        Connect Gmail Account
                    </a>
                </div>
            </div>
            {% endif %}
            
            {% if has_gmail %}
            <!-- Loading Indicator -->
            <div class="loading" id="loading" style="display: none;">
                <div class="spinner"></div>
                <p style="color: var(--text-secondary); font-weight: 500;">Loading emails...</p>
            </div>
            
            <!-- Older Emails Fetch Progress Bar -->
            <div class="older-emails-progress" id="olderEmailsProgress" style="display: none;">
                <div class="progress-container">
                    <div class="progress-header">
                        <span class="progress-title">üìß Fetching older emails...</span>
                        <button class="progress-close" onclick="stopOlderEmailsFetch()" title="Stop fetching">√ó</button>
                    </div>
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar-fill" id="olderEmailsProgressBar"></div>
                    </div>
                    <div class="progress-stats" id="olderEmailsStats">
                        <span>Fetched: <strong id="olderEmailsFetched">0</strong></span>
                        <span>Classified: <strong id="olderEmailsClassified">0</strong></span>
                        <span>Total: <strong id="olderEmailsTotal">200</strong></span>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Email List / Deal Flow List - Always render, but hide during setup -->
            <div id="contentArea" {% if needs_setup %}style="display: none;"{% endif %}>
            <!-- Email List (for all tabs except Deal Flow) -->
            <div class="email-list" id="emailList">
                <div class="empty-state" id="emptyStateInitial" style="display: none;">
                    <div class="spinner"></div>
                    <p>Loading emails...</p>
                </div>
            </div>

            <!-- Deal Flow Table -->
            <div class="deal-flow-table" id="dealFlowTable" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">Deal Flow</h2>
                    <!-- Scoring system removed - button disabled -->
                </div>
                <table class="deal-table">
                    <thead>
                        <tr>
                            <th>Founder</th>
                            <th>Subject</th>
                            <th>Deck</th>
                            <th>Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="dealFlowBody">
                        <tr>
                            <td colspan="5" class="empty-state">Loading deals...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            </div>
        </main>
    </div>

    <!-- Modal for email details -->
    <div class="modal" id="emailModal" style="display: none;">
        <div class="email-modal-content">
            <!-- Header - Row 1: Subject + Timestamp + Close -->
            <div class="email-modal-header-row1">
                <h2 class="email-modal-subject" id="modalSubject">Email Subject</h2>
                <div class="email-modal-header-right">
                    <span class="email-modal-date" id="modalDate"></span>
                    <button class="email-modal-close" onclick="closeModal()" title="Close">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Header - Row 2: Sender Info + Category Badge -->
            <div class="email-modal-header-row2">
                <div class="email-modal-sender-info">
                    <div class="email-modal-avatar" id="modalAvatar">A</div>
                    <div class="email-modal-sender-details">
                        <div class="email-modal-sender-name" id="modalFrom">Sender Name</div>
                        <div class="email-modal-sender-email" id="modalFromEmail">sender@example.com</div>
                    </div>
                </div>
                <div class="email-modal-category-badge" id="modalCategoryBadge"></div>
            </div>
            
            <!-- Recipients (To/Cc/Bcc) -->
            <div class="email-modal-recipients" id="modalRecipients" style="display: none;">
                <div id="modalTo"></div>
                <div id="modalCc" style="display: none;"></div>
                <div id="modalBcc" style="display: none;"></div>
            </div>
            
            <!-- Header Divider -->
            <div class="email-modal-header-divider"></div>
            
            <!-- Action Bar -->
            <div class="email-modal-action-bar">
                <button class="email-action-btn email-action-primary" onclick="openReplyComposer()" title="Reply">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 10 4 15 9 20"></polyline>
                        <path d="M20 4v7a4 4 0 0 1-4 4H4"></path>
                    </svg>
                    Reply
                </button>
                <button class="email-action-btn email-action-secondary" onclick="openReplyAllComposer()" title="Reply All">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 10 4 15 9 20"></polyline>
                        <path d="M20 4v7a4 4 0 0 1-4 4H4"></path>
                    </svg>
                    Reply All
                </button>
                <button class="email-action-btn email-action-secondary" onclick="openForwardComposer()" title="Forward">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 17 20 12 15 7"></polyline>
                        <path d="M4 18v-5a4 4 0 0 1 4-4h12"></path>
                    </svg>
                    Forward
                </button>
                <button class="email-action-btn email-action-secondary" onclick="archiveEmail()" title="Archive">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="9" y1="9" x2="15" y2="9"></line>
                        <line x1="9" y1="15" x2="15" y2="15"></line>
                    </svg>
                    Archive
                </button>
                <button class="email-action-btn email-action-secondary" onclick="markAsUnread()" title="Mark as Unread">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                        <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                    Mark Unread
                </button>
                <button class="email-action-btn email-action-danger" onclick="deleteCurrentEmail()" title="Delete">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    Delete
                </button>
            </div>
            
            <!-- Spam Warning Banner (optional) -->
            <div class="email-modal-spam-warning" id="modalSpamWarning" style="display: none;">
                <div class="spam-warning-content">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    <span>This message looks suspicious. Be careful with links and attachments.</span>
                </div>
                <div class="spam-warning-actions">
                    <button class="spam-action-btn spam-action-mark" onclick="markAsSpam()">Mark as spam & archive</button>
                    <button class="spam-action-btn spam-action-not" onclick="markAsNotSpam()">Not spam</button>
                </div>
            </div>
            
            <!-- Email Body Area -->
            <div class="email-modal-body">
                <div class="email-body-content">
                    <div class="thread-container" id="threadContainer">
                        <!-- Thread messages will be populated here -->
                    </div>
                    
                    <div class="email-body-section" id="singleEmailSection" style="display: none;">
                        <div id="modalAttachments" style="margin-bottom: 16px;"></div>
                        <div class="email-body" id="modalBody"></div>
                    </div>
                </div>
            </div>
            
            <!-- Rich Composer Section -->
            <div class="composer-section" id="composerSection" style="display: none;">
                <h3 id="composerTitle">Reply</h3>
                <div class="composer-form">
                    <div class="composer-field">
                        <label>To:</label>
                        <input type="email" id="composerTo" class="form-control" placeholder="recipient@example.com">
                    </div>
                    <div class="cc-bcc-toggle">
                        <button class="btn btn-small btn-text" onclick="toggleCCBCC()">Cc/Bcc</button>
                    </div>
                    <div class="cc-bcc-fields" id="ccBccFields" style="display: none;">
                        <div class="composer-field">
                            <label>Cc:</label>
                            <input type="email" id="composerCc" class="form-control" placeholder="cc@example.com">
                        </div>
                        <div class="composer-field">
                            <label>Bcc:</label>
                            <input type="email" id="composerBcc" class="form-control" placeholder="bcc@example.com">
                        </div>
                    </div>
                    <div class="composer-field">
                        <label>Subject:</label>
                        <input type="text" id="composerSubject" class="form-control" placeholder="Email subject">
                    </div>
                    <div class="composer-toolbar">
                        <button class="btn btn-small btn-icon" onclick="applyFormatting('bold')" title="Bold"><b>B</b></button>
                        <button class="btn btn-small btn-icon" onclick="applyFormatting('italic')" title="Italic"><i>I</i></button>
                        <button class="btn btn-small btn-icon" onclick="applyFormatting('underline')" title="Underline"><u>U</u></button>
                        <span class="toolbar-divider"></span>
                        <label class="btn btn-small btn-icon" title="Attach files">
                            üìé
                            <input type="file" id="composerFileInput" multiple style="display: none;" onchange="handleAttachmentUpload(event)">
                        </label>
                    </div>
                    <div class="composer-field">
                        <textarea id="composerBody" class="form-control composer-textarea" rows="10" placeholder="Write your message..."></textarea>
                    </div>
                    <div class="attachment-preview-list" id="attachmentPreviewList"></div>
                    <div class="composer-actions">
                        <button class="btn btn-primary" onclick="sendComposedEmail()">
                            ‚úâÔ∏è Send
                        </button>
                        <button class="btn btn-secondary" onclick="closeComposer()">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- AI Reply Section -->
            <div class="email-modal-footer">
                <div class="ai-reply-card">
                    <div class="ai-reply-header">
                        <div class="ai-reply-label">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="9" y1="9" x2="15" y2="9"></line>
                                <line x1="9" y1="15" x2="15" y2="15"></line>
                            </svg>
                            AI REPLY
                        </div>
                        <span class="ai-reply-status" id="aiReplyStatus">Ready</span>
                    </div>
                    <div class="ai-reply-content" id="replyContent" style="display: none;"></div>
                    <div class="ai-reply-loading" id="replyLoading" style="display: none;">
                        <div class="spinner-small"></div>
                        <span>Generating reply...</span>
                    </div>
                    <div class="ai-reply-actions">
                        <button class="ai-reply-generate-btn" onclick="generateReply()" id="generateReplyBtn">
                            Generate reply
                        </button>
                        <div class="ai-reply-helper" id="replyActions" style="display: none;">
                            <button class="ai-reply-send-btn" onclick="sendReply()">Send Reply</button>
                            <button class="ai-reply-edit-btn" onclick="editReply()">Edit</button>
                            <button class="ai-reply-skip-btn" onclick="markAsRead()">Skip</button>
                        </div>
                    </div>
                    <p class="ai-reply-helper-text">AI will generate a contextual reply based on this email</p>
                </div>
            </div>
        </div>
    </div>


    <!-- Compose Email Modal -->
    <div class="modal" id="composeModal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeComposeModal()">&times;</span>
            <div class="modal-header">
                <h2>Compose Email</h2>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-primary);">To:</label>
                    <input type="text" id="composeTo" class="compose-input" placeholder="recipient@example.com" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 12px;">
                    <button type="button" onclick="toggleCcBcc()" style="background: none; border: none; color: var(--primary-color, #6366f1); cursor: pointer; font-size: 13px; padding: 4px 0; text-decoration: underline;">
                        Cc, Bcc
                    </button>
                </div>
                <div id="composeCcBcc" style="display: none; margin-bottom: 16px;">
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-primary); font-size: 13px;">Cc:</label>
                        <input type="text" id="composeCc" class="compose-input" placeholder="cc@example.com" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-primary); font-size: 13px;">Bcc:</label>
                        <input type="text" id="composeBcc" class="compose-input" placeholder="bcc@example.com" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
                    </div>
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-primary);">Subject:</label>
                    <input type="text" id="composeSubject" class="compose-input" placeholder="Email subject" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-primary);">Message:</label>
                    <textarea id="composeBody" class="compose-textarea" placeholder="Type your message here..." style="width: 100%; min-height: 300px; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                </div>
                <div style="margin-bottom: 16px;">
                    <input type="file" id="composeAttachments" multiple style="display: none;" onchange="handleAttachmentSelection(event)">
                    <button type="button" class="btn btn-secondary btn-small" onclick="document.getElementById('composeAttachments').click()" style="display: inline-flex; align-items: center; gap: 6px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                        </svg>
                        Attach File
                    </button>
                    <div id="attachmentList" style="margin-top: 12px; display: none;"></div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="closeComposeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="sendComposedEmail()" id="sendComposeBtn">
                        <span id="sendComposeBtnText">Send</span>
                        <span id="sendComposeBtnSpinner" style="display: none;" class="spinner-small"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Signature Selector Modal -->
    <div class="modal" id="signatureModal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeSignatureModal()">&times;</span>
            <div class="modal-header">
                <h2>Select Email Signature</h2>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px; color: var(--text-secondary);">Choose which signature to use for your email replies:</p>
                <div id="signatureList" style="display: flex; flex-direction: column; gap: 12px;">
                    <div class="spinner-small"></div>
                    <p>Loading signatures...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Right-click Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="contextMenuReply()">
            <span>‚Ü©Ô∏è</span>
            <span>Reply</span>
        </div>
        <div class="context-menu-item" onclick="contextMenuForward()">
            <span>‚Ü™Ô∏è</span>
            <span>Forward</span>
        </div>
        <div class="context-menu-item" onclick="contextMenuMarkUnread()">
            <span>üìß</span>
            <span>Mark as Unread</span>
        </div>
        <div class="context-menu-item" onclick="contextMenuArchive()">
            <span>üì¶</span>
            <span>Archive</span>
        </div>
        <div class="context-menu-item" onclick="contextMenuDelete()">
            <span>üóëÔ∏è</span>
            <span>Delete</span>
        </div>
    </div>

    <!-- Settings Modal with Tabs -->
    <div class="modal modern-modal" id="settingsModal" style="display: none;">
        <div class="modal-content modern-modal-content">
            <div class="modern-modal-header">
                <div>
                    <h2 class="modern-modal-title">Settings</h2>
                    <p class="modern-modal-subtitle">Manage your account preferences and connections</p>
                </div>
                <button class="modern-modal-close" onclick="closeSettingsModal()" aria-label="Close">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <!-- Settings Tabs - Segmented Control -->
            <div class="modern-tabs-container">
                <button class="modern-tab active" onclick="switchSettingsTab('whatsapp')" id="tab-whatsapp">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 21l1.65-3.8a9 9 0 1 1 3.4 2.9L3 21"></path>
                        <path d="M9 10a.5.5 0 0 0 1 0V9a.5.5 0 0 0-1 0v1a5 5 0 0 0 5 5h1a.5.5 0 0 0 0-1h-1a.5.5 0 0 0 0 1"></path>
                    </svg>
                    <span>WhatsApp</span>
                </button>
                <button class="modern-tab" onclick="switchSettingsTab('gmail')" id="tab-gmail">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                        <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                    <span>Gmail</span>
                </button>
                <button class="modern-tab" onclick="switchSettingsTab('user')" id="tab-user">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span>User</span>
                </button>
            </div>
            
            <div class="modern-modal-body">
                <!-- WhatsApp Settings Tab -->
                <div class="settings-tab-content active" id="settings-whatsapp">
                    <div class="modern-settings-section">
                        <h3 class="modern-section-title">WhatsApp Notifications</h3>
                        <p class="modern-section-description">
                            Receive instant WhatsApp alerts when new deal flow emails arrive, and automatic follow-up reminders every 6 hours.
                        </p>
                        
                        <div class="modern-settings-item">
                            <div class="modern-toggle-container">
                                <label class="modern-toggle-label">
                                    <span class="modern-toggle-text">Enable WhatsApp alerts for deal flow</span>
                                    <div class="modern-toggle-switch">
                                        <input type="checkbox" id="whatsappEnabled" class="modern-toggle-input">
                                        <span class="modern-toggle-slider"></span>
                                    </div>
                                </label>
                                <p class="modern-helper-text">
                                    You'll receive alerts when new deals are detected and follow-ups every 6 hours
                                </p>
                            </div>
                        </div>
                        
                        <div class="modern-settings-item">
                            <label class="modern-input-label">WhatsApp Number</label>
                            <input 
                                type="tel" 
                                id="whatsappNumber" 
                                class="modern-input"
                                placeholder="+1234567890" 
                                pattern="^\+[1-9]\d{1,14}$"
                            >
                            <p class="modern-helper-text">
                                Include country code (e.g., +1234567890). Reply "STOP" to WhatsApp to disable follow-ups.
                            </p>
                        </div>
                        
                        <div class="modern-settings-item">
                            <label class="modern-input-label">WhatsApp Status</label>
                            <div class="modern-status-badge">
                                <span id="whatsappStatusBadge" class="modern-badge-text">Not configured</span>
                            </div>
                        </div>
                        
                        <div id="whatsappStatus" class="modern-status-message" style="display: none;"></div>
                    </div>
                </div>
                
                <!-- Gmail Settings Tab -->
                <div class="settings-tab-content" id="settings-gmail" style="display: none;">
                    <div class="modern-settings-section">
                        <h3 class="modern-section-title">Gmail Connection</h3>
                        <p class="modern-section-description">
                            Manage your Gmail account connection and settings.
                        </p>
                        
                        {% if has_gmail %}
                        <!-- Connected State -->
                        <div class="modern-settings-item">
                            <label class="modern-input-label">Connection Status</label>
                            <div class="modern-status-badge" style="background: #ECFDF5; padding: 10px 12px;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="m9 12 2 2 4-4"/>
                                </svg>
                                <span class="modern-badge-text" style="color: #10b981; font-weight: 500;">Gmail Connected</span>
                            </div>
                        </div>
                        
                        <div class="modern-settings-item">
                            <label class="modern-input-label">Connected Account</label>
                            <div class="modern-readonly-field" style="padding: 12px; background: #F9FAFB; border-radius: 8px;">
                                <span id="gmailEmail" style="font-weight: 500; color: #111827;">{{ gmail_email if gmail_email else 'Loading...' }}</span>
                            </div>
                        </div>
                        
                        <div class="modern-settings-item" style="margin-top: 20px;">
                            <button class="modern-btn-secondary" onclick="disconnectGmail()" style="width: 100%; padding: 12px; background: #FEE2E2; color: #DC2626; font-weight: 500; border-radius: 8px;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                                    <path d="M18 6L6 18M6 6l12 12"/>
                                </svg>
                                Disconnect Gmail Account
                            </button>
                        </div>
                        {% else %}
                        <!-- Not Connected State -->
                        <div class="modern-settings-item">
                            <label class="modern-input-label">Connection Status</label>
                            <div class="modern-status-badge" style="background: #FEE2E2; padding: 10px 12px;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#DC2626" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="15" y1="9" x2="9" y2="15"/>
                                    <line x1="9" y1="9" x2="15" y2="15"/>
                                </svg>
                                <span class="modern-badge-text" style="color: #DC2626; font-weight: 500;">Gmail Not Connected</span>
                            </div>
                        </div>
                        
                        <div class="modern-settings-item" style="margin-top: 20px;">
                            <a href="{{ url_for('connect_gmail') }}" class="modern-btn-primary" style="width: 100%; text-decoration: none; display: block; text-align: center; padding: 14px; font-weight: 600; border-radius: 8px;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                    <circle cx="12" cy="7" r="4"/>
                                </svg>
                                Connect Gmail Account
                            </a>
                        </div>
                        {% endif %}
                        
                        <div id="gmailStatus" class="modern-status-message" style="display: none;"></div>
                    </div>
                </div>
                
                <!-- User Settings Tab -->
                <div class="settings-tab-content" id="settings-user" style="display: none;">
                    <div class="modern-settings-section">
                        <h3 class="modern-section-title">User Profile</h3>
                        <p class="modern-section-description">
                            Manage your account information and preferences.
                        </p>
                        
                        {% if current_user.profile_picture %}
                        <div class="modern-settings-item" style="text-align: center; margin-bottom: 24px;">
                            <img src="{{ current_user.profile_picture }}" alt="{{ current_user.full_name or current_user.username }}" class="modern-profile-picture">
                            <p class="modern-helper-text" style="margin-top: 8px;">
                                Profile picture from Google
                            </p>
                        </div>
                        {% endif %}
                        
                        <div class="modern-settings-item">
                            <label class="modern-input-label">Username</label>
                            <input 
                                type="text" 
                                id="userUsername" 
                                class="modern-input"
                                value="{{ current_user.username }}" 
                                readonly
                            >
                            <p class="modern-helper-text">
                                Username cannot be changed
                            </p>
                        </div>
                        
                        <div class="modern-settings-item">
                            <label class="modern-input-label">Email</label>
                            <input 
                                type="email" 
                                id="userEmail" 
                                class="modern-input"
                                value="{{ current_user.email }}" 
                                readonly
                            >
                            <p class="modern-helper-text">
                                Email cannot be changed
                            </p>
                        </div>
                        
                        <div class="modern-settings-item">
                            <label class="modern-input-label">
                                Full Name
                                {% if current_user.google_id %}
                                <span style="color: #10b981; font-size: 11px; font-weight: 400; margin-left: 6px;">(from Google)</span>
                                {% endif %}
                            </label>
                            {% if current_user.full_name %}
                            <input 
                                type="text" 
                                id="userFullName" 
                                class="modern-input"
                                value="{{ current_user.full_name }}" 
                                {% if current_user.google_id %}readonly{% endif %}
                            >
                            <p class="modern-helper-text">
                                {% if current_user.google_id %}
                                Name is synced from your Google account
                                {% else %}
                                Enter your full name
                                {% endif %}
                            </p>
                            {% else %}
                            <input 
                                type="text" 
                                id="userFullName" 
                                class="modern-input"
                                placeholder="Enter your full name"
                            >
                            <p class="modern-helper-text">
                                Your name will be displayed in your profile
                            </p>
                            {% endif %}
                        </div>
                        
                        <div class="modern-settings-item">
                            <label class="modern-input-label">Account Created</label>
                            <div class="modern-readonly-field">
                                <span>{{ current_user.created_at.strftime('%B %d, %Y') if current_user.created_at else 'Unknown' }}</span>
                            </div>
                        </div>
                        
                        {% if current_user.google_id %}
                        <div class="modern-settings-item">
                            <label class="modern-input-label">Sign-in Method</label>
                            <div class="modern-readonly-field" style="display: flex; align-items: center; gap: 8px;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22.56 12.25c0-.78-.07-1.45-.2-2.11H12v3.94h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.91z" fill="#4285F4"/>
                                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                                </svg>
                                <span style="font-weight: 500;">Google Account</span>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div id="userStatus" class="modern-status-message" style="display: none;"></div>
                    </div>
                    
                    <!-- Danger Zone -->
                    <div class="modern-settings-section" style="margin-top: 32px; border-top: 1px solid #E5E7EB; padding-top: 24px;">
                        <h3 class="modern-section-title" style="color: #DC2626;">Danger Zone</h3>
                        <p class="modern-section-description">
                            Permanent actions that cannot be undone.
                        </p>
                        
                        <div class="modern-settings-item">
                            <button onclick="confirmDeleteAccount()" class="modern-btn-danger" style="width: 100%; padding: 12px; background: #FEE2E2; color: #DC2626; border: 1px solid #FCA5A5; font-weight: 600; border-radius: 8px; cursor: pointer; transition: all 0.15s ease;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                    <line x1="10" y1="11" x2="10" y2="17"/>
                                    <line x1="14" y1="11" x2="14" y2="17"/>
                                </svg>
                                Delete My Account
                            </button>
                            <p class="modern-helper-text" style="margin-top: 8px; color: #DC2626;">
                                ‚ö†Ô∏è This will permanently delete your account and all data. This action cannot be undone.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modern-modal-footer">
                <button class="modern-btn-secondary" onclick="closeSettingsModal()">Close</button>
                <button class="modern-btn-primary" onclick="saveAllSettings()" id="saveSettingsBtn" style="display: none;">Save Settings</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/cache.js') }}"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>

