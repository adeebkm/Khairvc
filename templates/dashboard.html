<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Replier - Khair</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/sidebar.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-content">
                <div class="nav-left">
                    <div class="nav-brand">
                        <span class="logo">Khair</span>
                        <span class="tagline">Email Replier Agent</span>
                    </div>
                </div>
                <div class="nav-right">
                    {% if has_gmail %}
                    <div class="nav-search">
                        <div class="search-container">
                            <span class="search-icon">üîç</span>
                            <input type="text" id="emailSearch" class="search-input" placeholder="Search emails..." onkeyup="handleSearch(event)" oninput="handleSearchInput(this.value)">
                            <button class="search-clear" id="searchClear" onclick="clearSearch()" style="display: none;">√ó</button>
                        </div>
                    </div>
                    {% endif %}
                    <div class="nav-actions">
                        {% if has_gmail %}
                        <button class="btn btn-secondary" onclick="openSignatureSelector()" title="Select email signature" style="font-size: 12px; padding: 6px 12px;">
                            ‚úèÔ∏è Signature
                        </button>
                        <button class="refresh-btn" id="refreshEmailsBtn" onclick="refreshEmails()" title="Refresh emails">
                            <span class="icon">üîÑ</span>
                        </button>
                        <div class="gmail-dropdown">
                            <button class="btn btn-gmail" onclick="toggleGmailDropdown(event)" id="gmailDropdownBtn">
                                üìß Connected
                            </button>
                            <div class="gmail-dropdown-menu" id="gmailDropdownMenu" style="display: none;">
                                <div class="gmail-dropdown-header">
                                    <strong>Connected Account</strong>
                                </div>
                                <div class="gmail-dropdown-email">
                                    {{ gmail_email or 'Gmail Connected' }}
                                </div>
                                <a href="{{ url_for('disconnect_gmail') }}" class="gmail-dropdown-disconnect">
                                    Disconnect
                                </a>
                            </div>
                        </div>
                        {% else %}
                        <a href="{{ url_for('connect_gmail') }}" class="btn btn-gmail" title="Connect Gmail account">
                            üìß Login
                        </a>
                        {% endif %}
                        <span class="user-info">{{ current_user.username }}</span>
                        <a href="{{ url_for('logout') }}" class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;">Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="dashboard-layout">
        {% if has_gmail %}
        <!-- Hamburger Menu Button (positioned above sidebar) -->
        <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
            <span class="hamburger-icon">‚ò∞</span>
        </button>
        
        <!-- Left Sidebar (Gmail-style) -->
        <aside class="sidebar" id="sidebar">
            <nav class="sidebar-nav">
                <button class="sidebar-item active" onclick="switchTab('all')" data-tab="all" data-label="Inbox">
                    <span class="sidebar-icon icon-inbox">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                        </svg>
                    </span>
                    <span class="sidebar-label">Inbox</span>
                </button>
                <button class="sidebar-item" onclick="switchTab('sent')" data-tab="sent" data-label="Sent">
                    <span class="sidebar-icon icon-sent">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </span>
                    <span class="sidebar-label">Sent</span>
                </button>
                <button class="sidebar-item" onclick="switchTab('starred')" data-tab="starred" data-label="Starred">
                    <span class="sidebar-icon icon-starred">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                        </svg>
                    </span>
                    <span class="sidebar-label">Starred</span>
                </button>
                <button class="sidebar-item" onclick="switchTab('drafts')" data-tab="drafts" data-label="Drafts">
                    <span class="sidebar-icon icon-drafts">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                    </span>
                    <span class="sidebar-label">Drafts</span>
                </button>
            </nav>
            
            <div class="sidebar-divider"></div>
            
            <div class="sidebar-section collapsed" id="categoriesSection">
                <div class="sidebar-section-title" onclick="toggleCategoriesSection()">CATEGORIES</div>
                <button class="sidebar-item" onclick="switchTab('deal-flow')" data-tab="deal-flow" data-label="Deal Flow">
                    <span class="sidebar-icon icon-deal-flow">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                        </svg>
                    </span>
                    <span class="sidebar-label">Deal Flow</span>
                </button>
                <button class="sidebar-item" onclick="switchTab('networking')" data-tab="networking" data-label="Networking">
                    <span class="sidebar-icon icon-networking">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                    </span>
                    <span class="sidebar-label">Networking</span>
                </button>
                <button class="sidebar-item" onclick="switchTab('hiring')" data-tab="hiring" data-label="Hiring">
                    <span class="sidebar-icon icon-hiring">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </span>
                    <span class="sidebar-label">Hiring</span>
                </button>
                <button class="sidebar-item" onclick="switchTab('general')" data-tab="general" data-label="General">
                    <span class="sidebar-icon icon-general">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                    </span>
                    <span class="sidebar-label">General</span>
                </button>
                <button class="sidebar-item" onclick="switchTab('spam')" data-tab="spam" data-label="Spam">
                    <span class="sidebar-icon icon-spam">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </span>
                    <span class="sidebar-label">Spam</span>
                </button>
            </div>
        </aside>
        {% endif %}

        <!-- Main Content Area -->
        <main class="main-content">
            {% if needs_setup %}
            <!-- First-Time Setup Screen -->
            <div class="setup-screen" id="setupScreen">
                <div class="setup-content">
                    <div class="setup-loading"></div>
                    <div class="setup-icon" id="setupIcon" style="display: none;">üöÄ</div>
                    <h2>Setting up your inbox...</h2>
                    <p>We're fetching and classifying your first 60 emails. This will just take a moment.</p>
                    <div class="setup-progress" id="setupProgress">
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="setupProgressBar"></div>
                        </div>
                        <p class="progress-text" id="setupProgressText">Initializing...</p>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if not has_gmail and not needs_setup %}
            <!-- Gmail Connection Required -->
            <div class="gmail-connection-prompt">
                <div class="gmail-connection-content">
                    <div class="gmail-connection-icon">üìß</div>
                    <h2>Connect Your Gmail Account</h2>
                    <p>To use Khair Email Replier Agent, you need to connect your Gmail account first.</p>
                    <p class="gmail-connection-subtitle">This allows the system to read and manage your emails securely.</p>
                    <a href="{{ url_for('connect_gmail') }}" class="btn btn-primary btn-large">
                        Connect Gmail Account
                    </a>
                </div>
            </div>
            {% endif %}
            
            {% if has_gmail %}
            <!-- Compact Header Section -->
            <div class="compact-header" {% if needs_setup %}style="display: none;"{% endif %}>
                <!-- Gmail Status (Compact) - Removed, now in navbar -->
                
                <!-- Controls -->
                <div class="controls-compact">
                    <div class="email-count-compact" id="emailCount"></div>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div class="loading" id="loading" style="display: none;">
                <div class="spinner"></div>
                <p style="color: var(--text-secondary); font-weight: 500;">Loading emails...</p>
            </div>
            
            <!-- Older Emails Fetch Progress Bar -->
            <div class="older-emails-progress" id="olderEmailsProgress" style="display: none;">
                <div class="progress-container">
                    <div class="progress-header">
                        <span class="progress-title">üìß Fetching older emails...</span>
                        <button class="progress-close" onclick="stopOlderEmailsFetch()" title="Stop fetching">√ó</button>
                    </div>
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar-fill" id="olderEmailsProgressBar"></div>
                    </div>
                    <div class="progress-stats" id="olderEmailsStats">
                        <span>Fetched: <strong id="olderEmailsFetched">0</strong></span>
                        <span>Classified: <strong id="olderEmailsClassified">0</strong></span>
                        <span>Total: <strong id="olderEmailsTotal">200</strong></span>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Email List / Deal Flow List - Always render, but hide during setup -->
            <div id="contentArea" {% if needs_setup %}style="display: none;"{% endif %}>
            <!-- Email List (for all tabs except Deal Flow) -->
            <div class="email-list" id="emailList">
                <div class="empty-state" id="emptyStateInitial" style="display: none;">
                    <div class="spinner"></div>
                    <p>Loading emails...</p>
                </div>
            </div>

            <!-- Deal Flow Table -->
            <div class="deal-flow-table" id="dealFlowTable" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">üíº Deal Flow</h2>
                    <!-- Scoring system removed - button disabled -->
                </div>
                <table class="deal-table">
                    <thead>
                        <tr>
                            <th>Founder</th>
                            <th>Subject</th>
                            <th>State</th>
                            <th>Deck Link</th>
                            <th>Basics</th>
                            <th>Portfolio Overlaps</th>
                            <th>Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="dealFlowBody">
                        <tr>
                            <td colspan="8" class="empty-state">Loading deals...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            </div>
        </main>
    </div>

    <!-- Modal for email details -->
    <div class="modal" id="emailModal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div class="modal-header">
                <div class="modal-header-top">
                    <h2 id="modalSubject">Email Subject</h2>
                </div>
                <div class="modal-from-section">
                    <div class="modal-avatar" id="modalAvatar">A</div>
                    <div class="modal-from-info">
                        <span class="modal-from" id="modalFrom">Sender Name</span>
                        <span class="modal-from-email" id="modalFromEmail">sender@example.com</span>
                    </div>
                    <div class="modal-date" id="modalDate"></div>
                </div>
                <div class="modal-metadata">
                    <div id="modalTags" class="modal-tags"></div>
                </div>
            </div>
            <div class="modal-body">
                <div class="thread-container" id="threadContainer">
                    <!-- Thread messages will be populated here -->
                </div>
                
                <div class="email-body-section" id="singleEmailSection" style="display: none;">
                    <h3>Original Email</h3>
                    <div id="modalAttachments" style="margin-bottom: 16px;"></div>
                    <div class="email-body" id="modalBody"></div>
                </div>
                
                <div class="reply-section" id="replySection" style="display: none;">
                    <h3>AI Generated Reply</h3>
                    <div class="reply-controls">
                        <button class="btn btn-small btn-primary" onclick="generateReply()">
                            ü§ñ Generate Reply
                        </button>
                    </div>
                    <div class="reply-loading" id="replyLoading" style="display: none;">
                        <div class="spinner-small"></div>
                        <p>AI is generating a reply...</p>
                    </div>
                    <div class="reply-content" id="replyContent"></div>
                    <textarea class="reply-editor" id="replyEditor" style="display: none;"></textarea>
                    <div class="reply-actions" id="replyActions" style="display: none;">
                        <button class="btn btn-success" onclick="sendReply()">
                            ‚úâÔ∏è Send Reply
                        </button>
                        <button class="btn btn-secondary" onclick="editReply()">
                            ‚úèÔ∏è Edit
                        </button>
                        <button class="btn btn-danger" onclick="markAsRead()">
                            ‚úì Mark as Read (Skip)
                        </button>
                    </div>
                </div>
            </div>
        </div>
        </main>
    </div>


    <!-- Compose Email Modal -->
    <div class="modal" id="composeModal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeComposeModal()">&times;</span>
            <div class="modal-header">
                <h2>Compose Email</h2>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-primary);">To:</label>
                    <input type="text" id="composeTo" class="compose-input" placeholder="recipient@example.com" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-primary);">Subject:</label>
                    <input type="text" id="composeSubject" class="compose-input" placeholder="Email subject" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-primary);">Message:</label>
                    <textarea id="composeBody" class="compose-textarea" placeholder="Type your message here..." style="width: 100%; min-height: 300px; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="closeComposeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="sendComposedEmail()" id="sendComposeBtn">
                        <span id="sendComposeBtnText">Send</span>
                        <span id="sendComposeBtnSpinner" style="display: none;" class="spinner-small"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Signature Selector Modal -->
    <div class="modal" id="signatureModal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeSignatureModal()">&times;</span>
            <div class="modal-header">
                <h2>Select Email Signature</h2>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px; color: var(--text-secondary);">Choose which signature to use for your email replies:</p>
                <div id="signatureList" style="display: flex; flex-direction: column; gap: 12px;">
                    <div class="spinner-small"></div>
                    <p>Loading signatures...</p>
                </div>
            </div>
        </div>
    </div>

    {% if has_gmail %}
    <!-- Floating Compose Button -->
    <button class="floating-compose" onclick="openComposeModal()" title="Compose new email">
        ‚úâÔ∏è
    </button>
    {% endif %}

    <!-- Right-click Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="contextMenuReply()">
            <span>‚Ü©Ô∏è</span>
            <span>Reply</span>
        </div>
        <div class="context-menu-item" onclick="contextMenuForward()">
            <span>‚Ü™Ô∏è</span>
            <span>Forward</span>
        </div>
        <div class="context-menu-item" onclick="contextMenuArchive()">
            <span>üì¶</span>
            <span>Archive</span>
        </div>
        <div class="context-menu-item" onclick="contextMenuDelete()">
            <span>üóëÔ∏è</span>
            <span>Delete</span>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>

